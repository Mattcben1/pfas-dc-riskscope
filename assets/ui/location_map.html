<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PFAS DC RiskScope – Location Picker</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    #map { height: 400px; }
    body { font-family: system-ui, sans-serif; margin: 1rem; }
    .panel { margin-top: 1rem; }
    label { display: block; margin-top: 0.5rem; }
    input, textarea { width: 100%; }
  </style>
</head>
<body>
  <h2>PFAS DC RiskScope – Click to Select a Site</h2>
  <div id="map"></div>

  <div class="panel">
    <p>Clicked location: <span id="coords">none</span></p>

    <label>Receiving flow (MGD):
      <input id="receiving_flow" type="number" value="42.0" step="0.1" />
    </label>
    <label>Discharge flow (MGD):
      <input id="discharge_flow" type="number" value="3.5" step="0.1" />
    </label>

    <label>PFAS discharge (ppt, JSON dict):
      <textarea id="pfas_json" rows="4">
{
  "PFOA": 7.5,
  "PFOS": 6.2,
  "HFPO-DA": 5.0
}
      </textarea>
    </label>

    <button id="run_sim">Run Simulation</button>
    <button id="download_pdf">Download PDF</button>

    <pre id="result" style="margin-top:1rem; background:#f5f5f5; padding:0.5rem; max-height:300px; overflow:auto;"></pre>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([38.9, -77.3], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker = null;
    let currentLat = null;
    let currentLon = null;

    map.on('click', function(e) {
      currentLat = e.latlng.lat;
      currentLon = e.latlng.lng;

      if (marker) {
        marker.setLatLng(e.latlng);
      } else {
        marker = L.marker(e.latlng).addTo(map);
      }

      document.getElementById('coords').textContent =
        currentLat.toFixed(4) + ', ' + currentLon.toFixed(4);
    });

    async function callApi(path, method) {
      const receiving = parseFloat(document.getElementById('receiving_flow').value);
      const discharge = parseFloat(document.getElementById('discharge_flow').value);
      const pfas = JSON.parse(document.getElementById('pfas_json').value);

      if (currentLat === null || currentLon === null) {
        alert('Click on the map to choose a location first.');
        return;
      }

      const body = {
        lat: currentLat,
        lon: currentLon,
        receiving_flow_mgd: receiving,
        discharge_flow_mgd: discharge,
        discharge_pfas_ppt: pfas
      };

      const resp = await fetch(path, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!resp.ok) {
        const err = await resp.json();
        alert('Error: ' + JSON.stringify(err));
        return;
      }

      if (path.includes('export-pdf')) {
        // Download PDF
        const blob = await resp.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pfas_risk_report_location.pdf';
        a.click();
        return;
      } else {
        const data = await resp.json();
        document.getElementById('result').textContent =
          JSON.stringify(data, null, 2);
      }
    }

    document.getElementById('run_sim').onclick = function() {
      callApi('/simulate-location', 'POST');
    };

    document.getElementById('download_pdf').onclick = function() {
      callApi('/export-pdf-location', 'POST');
    };
  </script>
</body>
</html>
