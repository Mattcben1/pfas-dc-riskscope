<!-- src/ui/dashboard.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PFAS RiskScope – Dashboard</title>
    <style>
        body { margin:0; font-family:Arial,sans-serif; display:flex; height:100vh; }
        #left {
            width:40%; padding:20px; border-right:1px solid #ccc;
            box-sizing:border-box; overflow-y:auto;
        }
        #right {
            width:60%; padding:20px; box-sizing:border-box;
            overflow-y:auto;
        }
        button {
            padding:10px 16px; margin-top:10px;
            background:#2D79F6; color:white; border:none; border-radius:5px;
            cursor:pointer;
        }
        button:hover { background:#1c5edb; }
        pre {
            background:#eee; padding:10px; border-radius:6px;
            white-space:pre-wrap;
        }
        input { width:80px; margin-bottom:5px; }
    </style>
</head>
<body>

<div id="left">
    <h2>Simulation Controls</h2>
    <p id="coords">Coordinates: —</p>
    <p id="stateLabel">State (FIPS): —</p>
    <p id="bgLabel">Background PFAS: — ppt</p>

    <h3>Data Center Discharge PFAS (ppt)</h3>
    <label>PFOA: <input id="pfoaInput" type="number" step="0.1"></label><br>
    <label>PFOS: <input id="pfosInput" type="number" step="0.1"></label><br>

    <h3>Hydrology</h3>
    <p id="flows">Receiving flow: — MGD, Discharge: — MGD</p>

    <button id="runBtn">Run Simulation</button>
    <button id="pdfBtn">Export PDF</button>
</div>

<div id="right">
    <h2>Results</h2>
    <pre id="out">Awaiting simulation.</pre>
</div>

<script>
    const qs = new URLSearchParams(window.location.search);

    const lat = parseFloat(qs.get("lat") || "0");
    const lon = parseFloat(qs.get("lon") || "0");
    const state = qs.get("state") || "US";
    const bg = parseFloat(qs.get("bg") || "0");
    const rf = parseFloat(qs.get("rf") || "50");
    const df = parseFloat(qs.get("df") || "3");
    const bgPfoa = parseFloat(qs.get("pfoa") || bg || "0");
    const bgPfos = parseFloat(qs.get("pfos") || (bg * 0.8) || "0");

    const coordsEl = document.getElementById("coords");
    const stateEl = document.getElementById("stateLabel");
    const bgEl = document.getElementById("bgLabel");
    const flowsEl = document.getElementById("flows");
    const pfoaInput = document.getElementById("pfoaInput");
    const pfosInput = document.getElementById("pfosInput");
    const outEl = document.getElementById("out");

    if (coordsEl && !Number.isNaN(lat) && !Number.isNaN(lon)) {
        coordsEl.textContent = `Coordinates: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    }
    if (stateEl) {
        stateEl.textContent = `State (FIPS): ${state}`;
    }
    if (bgEl && !Number.isNaN(bg)) {
        bgEl.textContent = `Background PFAS (approx): ${bg.toFixed(2)} ppt`;
    }
    if (flowsEl) {
        flowsEl.textContent = `Receiving flow: ${rf} MGD, Discharge: ${df} MGD`;
    }

    if (pfoaInput) pfoaInput.value = bgPfoa.toFixed(2);
    if (pfosInput) pfosInput.value = bgPfos.toFixed(2);

    async function callSim(endpoint) {
        const payload = {
            state: state,
            lat: lat,
            lon: lon,
            chemicals: {
                concentrations_ppt: {
                    PFOA: parseFloat(pfoaInput.value || "0"),
                    PFOS: parseFloat(pfosInput.value || "0"),
                    PFHxS: 0.5,
                    PFNA: 0.2,
                    "HFPO-DA": 0.1,
                    PFBS: 0.4
                }
            },
            environmental_factors: {
                groundwater_vulnerability_index: 0.6,
                surface_water_distance_km: 1.0,
                water_stress_category: "moderate",
                receiving_water_flow_cfs: rf * 1.547
            },
            data_center: {
                cooling_type: "evaporative",
                max_daily_water_withdrawal_mgd: df
            }
        };

        const resp = await fetch(endpoint, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        });

        return resp;
    }

    document.getElementById("runBtn").onclick = async () => {
        try {
            const resp = await callSim("/simulate");
            const json = await resp.json();
            outEl.textContent = JSON.stringify(json, null, 2);
        } catch (err) {
            outEl.textContent = "Error running simulation: " + err;
        }
    };

    document.getElementById("pdfBtn").onclick = async () => {
        try {
            const resp = await callSim("/export-pdf");
            if (!resp.ok) {
                const err = await resp.text();
                alert("PDF error: " + err);
                return;
            }
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "pfas_risk_report.pdf";
            a.click();
        } catch (err) {
            alert("PDF generation failed: " + err);
        }
    };
</script>

</body>
</html>
