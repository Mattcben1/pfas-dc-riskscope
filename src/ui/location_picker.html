<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PFAS DC RiskScope ‚Äì Site Picker</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #map {
            height: 500px;
            width: 100%;
            border: 2px solid #444;
            border-radius: 8px;
        }
        .info-box {
            margin-top: 20px;
            padding: 12px;
            background: #f2f2f2;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        input {
            width: 280px;
            padding: 6px;
            margin: 5px 0;
        }
    </style>
</head>

<body>

<h2>üìç PFAS DC RiskScope ‚Äì Select a Site</h2>
<p>Click anywhere on the map to auto-populate hydrology & location data.</p>

<div id="map"></div>

<div class="info-box">
    <h3>Location Picked</h3>
    <label>Latitude:</label><br>
    <input id="lat" readonly><br>

    <label>Longitude:</label><br>
    <input id="lon" readonly><br>

    <label>State (auto-filled):</label><br>
    <input id="state" readonly><br>
</div>

<div class="info-box">
    <h3>Auto-Filled Hydrological Inputs</h3>

    <label>Receiving Flow (MGD):</label><br>
    <input id="receiving_flow" readonly><br>

    <label>Discharge Flow (MGD):</label><br>
    <input id="discharge_flow" readonly><br>
</div>

<div class="info-box">
    <h3>Ready to Simulate?</h3>
    <p>These values will flow directly into the simulation engine.</p>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    //--------------------------------------
    // 1. Initialize Map (center on Virginia)
    //--------------------------------------
    const map = L.map('map').setView([38.8, -77.3], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18
    }).addTo(map);

    let marker = null;

    //--------------------------------------
    // 2. Handle user clicks
    //--------------------------------------
    map.on("click", async (e) => {
        const lat = e.latlng.lat.toFixed(5);
        const lon = e.latlng.lng.toFixed(5);

        console.log("Map clicked:", lat, lon);

        // place marker
        if (marker) marker.remove();
        marker = L.marker([lat, lon]).addTo(map);

        // update UI immediately
        document.getElementById("lat").value = lat;
        document.getElementById("lon").value = lon;

        //--------------------------------------
        // 3. Ask backend for auto-filled data
        //--------------------------------------
        try {
            const response = await fetch("/simulate-location", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ lat: Number(lat), lon: Number(lon) })
            });

            if (!response.ok) {
                throw new Error("Server returned " + response.status);
            }

            const data = await response.json();
            console.log("Backend returned:", data);

            // Fill auto-loaded values
            document.getElementById("state").value          = data.state;
            document.getElementById("receiving_flow").value = data.receiving_flow_mgd;
            document.getElementById("discharge_flow").value = data.discharge_flow_mgd;

        } catch (err) {
            console.error("ERROR contacting backend:", err);
            alert("Could not load location details. Check server logs.");
        }
    });
</script>

</body>
</html>
