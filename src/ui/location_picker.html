<!-- src/ui/location_picker.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PFAS RiskScope – Location Picker</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; }
        #map { width: 70%; height: 100%; }
        #sidebar {
            width: 30%; padding: 20px; background: #f6f6f6;
            border-left: 2px solid #ddd;
        }
        .title { font-size: 20px; margin-bottom: 10px; }
        button {
            padding: 10px 14px; margin-top: 10px;
            background: #2D79F6; color: white; border: none; border-radius: 5px;
        }
        button:hover { background: #1c5edb; cursor: pointer; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="sidebar">
    <div class="title">Pick a location</div>
    <p>Click the map to auto-fill PFAS background and water flow assumptions.</p>

    <p><strong>Latitude:</strong> <span id="lat">—</span></p>
    <p><strong>Longitude:</strong> <span id="lon">—</span></p>
    <p><strong>State (FIPS):</strong> <span id="state">—</span></p>
    <p><strong>Background PFOA:</strong> <span id="pfoa">—</span> ppt</p>
    <p><strong>Background PFOS:</strong> <span id="pfos">—</span> ppt</p>
    <p><strong>Combined PFAS median:</strong> <span id="bg">—</span> ppt</p>

    <button id="go">Go to Dashboard</button>
</div>

<script>
    let map = L.map('map').setView([38.9, -77.1], 9);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    let marker = null;
    let chosen = null;

    map.on("click", async (e) => {
        if (marker) marker.remove();
        marker = L.marker(e.latlng).addTo(map);

        document.getElementById("lat").textContent = e.latlng.lat.toFixed(6);
        document.getElementById("lon").textContent = e.latlng.lng.toFixed(6);

        const resp = await fetch("/simulate-location", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ lat: e.latlng.lat, lon: e.latlng.lng })
        });

        const data = await resp.json();
        chosen = data;

        document.getElementById("state").textContent = data.state;
        document.getElementById("pfoa").textContent = data.background_pfoa_ppt.toFixed(2);
        document.getElementById("pfos").textContent = data.background_pfos_ppt.toFixed(2);
        document.getElementById("bg").textContent = data.background_pfas_median_ppt.toFixed(2);
    });

    document.getElementById("go").onclick = () => {
        if (!chosen) {
            alert("Click a location on the map first.");
            return;
        }

        const url = `/dashboard?lat=${chosen.lat}`
                  + `&lon=${chosen.lon}`
                  + `&state=${chosen.state}`
                  + `&bg=${chosen.background_pfas_median_ppt}`
                  + `&pfoa=${chosen.background_pfoa_ppt}`
                  + `&pfos=${chosen.background_pfos_ppt}`
                  + `&rf=${chosen.receiving_flow_mgd}`
                  + `&df=${chosen.discharge_flow_mgd}`;

        window.location.href = url;
    };
</script>

</body>
</html>
